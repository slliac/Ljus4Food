\mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}} helps you create deep copies (clones) of your objects. It is designed to handle cycles in the association graph.

\href{https://travis-ci.org/myclabs/DeepCopy}{\tt } \href{https://coveralls.io/r/myclabs/DeepCopy?branch=master}{\tt } \href{https://scrutinizer-ci.com/g/myclabs/DeepCopy/}{\tt } \href{https://packagist.org/packages/myclabs/deep-copy}{\tt }

\subsection*{Table of Contents}


\begin{DoxyEnumerate}
\item \href{#how}{\tt How}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#why}{\tt Why}
\begin{DoxyEnumerate}
\item \href{#using-simply-clone}{\tt Using simply {\ttfamily clone}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#overridding-__clone}{\tt Overridding {\ttfamily \+\_\+\+\_\+clone()}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#with-deepcopy}{\tt With {\ttfamily Deep\+Copy}}
\end{DoxyEnumerate}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#how-it-works}{\tt How it works}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#going-further}{\tt Going further}
\begin{DoxyEnumerate}
\item \href{#matchers}{\tt Matchers}
\begin{DoxyEnumerate}
\item \href{#property-name}{\tt Property name}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#specific-property}{\tt Specific property}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#type}{\tt Type}
\end{DoxyEnumerate}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#filters}{\tt Filters}
\begin{DoxyEnumerate}
\item \href{#setnullfilter-filter}{\tt {\ttfamily Set\+Null\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#keepfilter-filter}{\tt {\ttfamily Keep\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#doctrinecollectionfilter-filter}{\tt {\ttfamily Doctrine\+Collection\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#doctrineemptycollectionfilter-filter}{\tt {\ttfamily Doctrine\+Empty\+Collection\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#doctrineproxyfilter-filter}{\tt {\ttfamily Doctrine\+Proxy\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#replacefilter-type-filter}{\tt {\ttfamily Replace\+Filter}}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#doctrinecollectionfilter-type-filter}{\tt {\ttfamily Shallow\+Copy\+Filter}}
\end{DoxyEnumerate}
\end{DoxyEnumerate}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#edge-cases}{\tt Edge cases}
\end{DoxyEnumerate}
\begin{DoxyEnumerate}
\item \href{#contributing}{\tt Contributing}
\begin{DoxyEnumerate}
\item \href{#tests}{\tt Tests}
\end{DoxyEnumerate}
\end{DoxyEnumerate}

\subsection*{How?}

Install with \mbox{\hyperlink{namespace_composer}{Composer}}\+:


\begin{DoxyCode}
composer require myclabs/deep-copy
\end{DoxyCode}


Use simply\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$myCopy = $copier->copy($myObject);
\end{DoxyCode}


\subsection*{Why?}


\begin{DoxyItemize}
\item How do you create copies of your objects?
\end{DoxyItemize}


\begin{DoxyCode}
$myCopy = clone $myObject;
\end{DoxyCode}



\begin{DoxyItemize}
\item How do you create {\bfseries deep} copies of your objects (i.\+e. copying also all the objects referenced in the properties)?
\end{DoxyItemize}

You use \href{http://www.php.net/manual/en/language.oop5.cloning.php#object.clone}{\tt {\ttfamily \+\_\+\+\_\+clone()}} and implement the behavior yourself.


\begin{DoxyItemize}
\item But how do you handle {\bfseries cycles} in the association graph?
\end{DoxyItemize}

Now you\textquotesingle{}re in for a big mess \+:(



\subsubsection*{Using simply {\ttfamily clone}}



\subsubsection*{Overridding {\ttfamily \+\_\+\+\_\+clone()}}



\subsubsection*{With {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}}}



\subsection*{How it works}

\mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}} recursively traverses all the object\textquotesingle{}s properties and clones them. To avoid cloning the same object twice it keeps a hash map of all instances and thus preserves the object graph.

To use it\+:


\begin{DoxyCode}
use \textcolor{keyword}{function} \mbox{\hyperlink{namespace_deep_copy_a9fb9a0a04a3453639d27a6d6fba4a2b6}{DeepCopy\(\backslash\)deep\_copy}};

$copy = \mbox{\hyperlink{namespace_deep_copy_a9fb9a0a04a3453639d27a6d6fba4a2b6}{deep\_copy}}($var);
\end{DoxyCode}


Alternatively, you can create your own {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}} instance to configure it differently for example\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}(\textcolor{keyword}{true});

$copy = $copier->copy($var);
\end{DoxyCode}


You may want to roll your own deep copy function\+:


\begin{DoxyCode}
\textcolor{keyword}{namespace }Acme;

use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};

\textcolor{keyword}{function} \mbox{\hyperlink{namespace_deep_copy_a9fb9a0a04a3453639d27a6d6fba4a2b6}{deep\_copy}}($var)
\{
    \textcolor{keyword}{static} $copier = null;

    \textcolor{keywordflow}{if} (null === $copier) \{
        $copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}(\textcolor{keyword}{true});
    \}

    \textcolor{keywordflow}{return} $copier->copy($var);
\}
\end{DoxyCode}


\subsection*{Going further}

You can add filters to customize the copy process.

The method to add a filter is {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Deep\+Copy\+::add\+Filter(\$filter, \$matcher)}, with {\ttfamily \$filter} implementing {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Filter\textbackslash{}Filter} and {\ttfamily \$matcher} implementing {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Matcher\textbackslash{}Matcher}.

We provide some generic filters and matchers.

\subsubsection*{Matchers}


\begin{DoxyItemize}
\item {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Matcher} applies on a object attribute.
\item {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Type\+Matcher} applies on any element found in graph, including array elements.
\end{DoxyItemize}

\paragraph*{Property name}

The {\ttfamily Property\+Name\+Matcher} will match a property by its name\+:


\begin{DoxyCode}
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_name_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyNameMatcher}};

\textcolor{comment}{// Will apply a filter to any property of any objects named "id"}
$matcher = \textcolor{keyword}{new} PropertyNameMatcher(\textcolor{stringliteral}{'id'});
\end{DoxyCode}


\paragraph*{Specific property}

The {\ttfamily Property\+Matcher} will match a specific property of a specific class\+:


\begin{DoxyCode}
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyMatcher}};

\textcolor{comment}{// Will apply a filter to the property "id" of any objects of the class "MyClass"}
$matcher = \textcolor{keyword}{new} PropertyMatcher(\textcolor{stringliteral}{'MyClass'}, \textcolor{stringliteral}{'id'});
\end{DoxyCode}


\paragraph*{Type}

The {\ttfamily Type\+Matcher} will match any element by its type (instance of a class or any value that could be parameter of \href{http://php.net/manual/en/function.gettype.php}{\tt gettype()} function)\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_type_matcher_1_1_type_matcher}{DeepCopy\(\backslash\)TypeMatcher\(\backslash\)TypeMatcher}};

\textcolor{comment}{// Will apply a filter to any object that is an instance of Doctrine\(\backslash\)Common\(\backslash\)Collections\(\backslash\)Collection}
$matcher = \textcolor{keyword}{new} TypeMatcher(\textcolor{stringliteral}{'Doctrine\(\backslash\)Common\(\backslash\)Collections\(\backslash\)Collection'});
\end{DoxyCode}


\subsubsection*{Filters}


\begin{DoxyItemize}
\item {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Filter} applies a transformation to the object attribute matched by {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Matcher}
\item {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Type\+Filter} applies a transformation to any element matched by {\ttfamily \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}\textbackslash{}Type\+Matcher}
\end{DoxyItemize}

\paragraph*{{\ttfamily Set\+Null\+Filter} (filter)}

Let\textquotesingle{}s say for example that you are copying a database record (or a \mbox{\hyperlink{namespace_doctrine}{Doctrine}} entity), so you want the copy not to have any ID\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_set_null_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)SetNullFilter}};
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_name_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyNameMatcher}};

$object = MyClass::load(123);
echo $object->id; \textcolor{comment}{// 123}

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$copier->addFilter(\textcolor{keyword}{new} SetNullFilter(), \textcolor{keyword}{new} PropertyNameMatcher(\textcolor{stringliteral}{'id'}));

$copy = $copier->copy($object);

echo $copy->id; \textcolor{comment}{// null}
\end{DoxyCode}


\paragraph*{{\ttfamily Keep\+Filter} (filter)}

If you want a property to remain untouched (for example, an association to an object)\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_keep_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)KeepFilter}};
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$copier->addFilter(\textcolor{keyword}{new} KeepFilter(), \textcolor{keyword}{new} PropertyMatcher(\textcolor{stringliteral}{'MyClass'}, \textcolor{stringliteral}{'category'}));

$copy = $copier->copy($object);
\textcolor{comment}{// $copy->category has not been touched}
\end{DoxyCode}


\paragraph*{{\ttfamily Doctrine\+Collection\+Filter} (filter)}

If you use \mbox{\hyperlink{namespace_doctrine}{Doctrine}} and want to copy an entity, you will need to use the {\ttfamily Doctrine\+Collection\+Filter}\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_doctrine_1_1_doctrine_collection_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)Doctrine\(\backslash\)DoctrineCollectionFilter}};
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_type_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyTypeMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$copier->addFilter(\textcolor{keyword}{new} DoctrineCollectionFilter(), \textcolor{keyword}{new} PropertyTypeMatcher(\textcolor{stringliteral}{'Doctrine\(\backslash\)Common\(\backslash\)Collections\(\backslash\)C
      ollection'}));

$copy = $copier->copy($object);
\end{DoxyCode}


\paragraph*{{\ttfamily Doctrine\+Empty\+Collection\+Filter} (filter)}

If you use \mbox{\hyperlink{namespace_doctrine}{Doctrine}} and want to copy an entity who contains a {\ttfamily Collection} that you want to be reset, you can use the {\ttfamily Doctrine\+Empty\+Collection\+Filter}


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_doctrine_1_1_doctrine_empty_collection_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)Doctrine\(\backslash\)DoctrineEmptyCollectionFilter}}
      ;
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$copier->addFilter(\textcolor{keyword}{new} DoctrineEmptyCollectionFilter(), \textcolor{keyword}{new} PropertyMatcher(\textcolor{stringliteral}{'MyClass'}, \textcolor{stringliteral}{'myProperty'}));

$copy = $copier->copy($object);

\textcolor{comment}{// $copy->myProperty will return an empty collection}
\end{DoxyCode}


\paragraph*{{\ttfamily Doctrine\+Proxy\+Filter} (filter)}

If you use \mbox{\hyperlink{namespace_doctrine}{Doctrine}} and use cloning on lazy loaded entities, you might encounter errors mentioning missing fields on a \mbox{\hyperlink{namespace_doctrine}{Doctrine}} proxy class (...\textbackslash{}\+\_\+\+\_\+\+C\+G\+\_\+\+\_\+). You can use the {\ttfamily Doctrine\+Proxy\+Filter} to load the actual entity behind the \mbox{\hyperlink{namespace_doctrine}{Doctrine}} proxy class. {\bfseries Make sure, though, to put this as one of your very first filters in the filter chain so that the entity is loaded before other filters are applied!}


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_doctrine_1_1_doctrine_proxy_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)Doctrine\(\backslash\)DoctrineProxyFilter}};
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_doctrine_1_1_doctrine_proxy_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)Doctrine\(\backslash\)DoctrineProxyMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$copier->addFilter(\textcolor{keyword}{new} DoctrineProxyFilter(), \textcolor{keyword}{new} DoctrineProxyMatcher());

$copy = $copier->copy($object);

\textcolor{comment}{// $copy should now contain a clone of all entities, including those that were not yet fully loaded.}
\end{DoxyCode}


\paragraph*{{\ttfamily Replace\+Filter} (type filter)}


\begin{DoxyEnumerate}
\item If you want to replace the value of a property\+:
\end{DoxyEnumerate}


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_filter_1_1_replace_filter}{DeepCopy\(\backslash\)Filter\(\backslash\)ReplaceFilter}};
use \mbox{\hyperlink{class_deep_copy_1_1_matcher_1_1_property_matcher}{DeepCopy\(\backslash\)Matcher\(\backslash\)PropertyMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$callback = \textcolor{keyword}{function} ($currentValue) \{
  \textcolor{keywordflow}{return} $currentValue . \textcolor{stringliteral}{' (copy)'}
\};
$copier->addFilter(\textcolor{keyword}{new} ReplaceFilter($callback), \textcolor{keyword}{new} PropertyMatcher(\textcolor{stringliteral}{'MyClass'}, \textcolor{stringliteral}{'title'}));

$copy = $copier->copy($object);

\textcolor{comment}{// $copy->title will contain the data returned by the callback, e.g. 'The title (copy)'}
\end{DoxyCode}



\begin{DoxyEnumerate}
\item If you want to replace whole element\+:
\end{DoxyEnumerate}


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_type_filter_1_1_replace_filter}{DeepCopy\(\backslash\)TypeFilter\(\backslash\)ReplaceFilter}};
use \mbox{\hyperlink{namespace_deep_copy_1_1_type_matcher_1_1_type_matcher}{DeepCopy\(\backslash\)TypeMatcher\(\backslash\)TypeMatcher}};

$copier = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$callback = \textcolor{keyword}{function} (MyClass $myClass) \{
  \textcolor{keywordflow}{return} get\_class($myClass);
\};
$copier->addTypeFilter(\textcolor{keyword}{new} ReplaceFilter($callback), \textcolor{keyword}{new} TypeMatcher(\textcolor{stringliteral}{'MyClass'}));

$copy = $copier->copy([\textcolor{keyword}{new} MyClass, \textcolor{stringliteral}{'some string'}, \textcolor{keyword}{new} MyClass]);

\textcolor{comment}{// $copy will contain ['MyClass', 'some string', 'MyClass']}
\end{DoxyCode}


The {\ttfamily \$callback} parameter of the {\ttfamily Replace\+Filter} constructor accepts any P\+HP callable.

\paragraph*{{\ttfamily Shallow\+Copy\+Filter} (type filter)}

Stop {\itshape \mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}}} from recursively copying element, using standard {\ttfamily clone} instead\+:


\begin{DoxyCode}
use \mbox{\hyperlink{namespace_deep_copy_1_1_deep_copy}{DeepCopy\(\backslash\)DeepCopy}};
use \mbox{\hyperlink{class_deep_copy_1_1_type_filter_1_1_shallow_copy_filter}{DeepCopy\(\backslash\)TypeFilter\(\backslash\)ShallowCopyFilter}};
use \mbox{\hyperlink{namespace_deep_copy_1_1_type_matcher_1_1_type_matcher}{DeepCopy\(\backslash\)TypeMatcher\(\backslash\)TypeMatcher}};
use Mockery as m;

$this->deepCopy = \textcolor{keyword}{new} \mbox{\hyperlink{namespace_deep_copy}{DeepCopy}}();
$this->deepCopy->addTypeFilter(
    \textcolor{keyword}{new} ShallowCopyFilter,
    \textcolor{keyword}{new} TypeMatcher(m\(\backslash\)MockInterface::class)
);

$myServiceWithMocks = \textcolor{keyword}{new} MyService(m::mock(MyDependency1::class), m::mock(MyDependency2::class));
\textcolor{comment}{// All mocks will be just cloned, not deep copied}
\end{DoxyCode}


\subsection*{Edge cases}

The following structures cannot be deep-\/copied with P\+HP Reflection. As a result they are shallow cloned and filters are not applied. There is two ways for you to handle them\+:


\begin{DoxyItemize}
\item Implement your own {\ttfamily \+\_\+\+\_\+clone()} method
\item Use a filter with a type matcher
\end{DoxyItemize}

\subsection*{Contributing}

\mbox{\hyperlink{namespace_deep_copy}{Deep\+Copy}} is distributed under the M\+IT license.

\subsubsection*{Tests}

Running the tests is simple\+:


\begin{DoxyCode}
vendor/bin/phpunit
\end{DoxyCode}
 